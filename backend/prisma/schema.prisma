// Prisma schema for Wedding Planner App
// This schema mirrors the PostgreSQL database created in database/init.sql

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =====================================================
// USERS & AUTHENTICATION
// =====================================================

model users {
  id             String    @id @default(uuid()) @db.Uuid
  email          String    @unique @db.VarChar(255)
  phone          String?   @db.VarChar(20)
  password_hash  String?   @db.VarChar(255)
  user_type      String    @db.VarChar(20)
  is_active      Boolean   @default(true)
  email_verified Boolean   @default(false)
  phone_verified Boolean   @default(false)
  created_at     DateTime  @default(now())
  updated_at     DateTime  @default(now()) @updatedAt

  // Relations
  vendor   vendors?
  weddings weddings[]
}

model admins {
  id            String    @id @default(uuid()) @db.Uuid
  email         String    @unique @db.VarChar(255)
  password_hash String    @db.VarChar(255)
  name          String?   @db.VarChar(100)
  role          String    @default("admin") @db.VarChar(20)
  is_active     Boolean   @default(true)
  last_login    DateTime?
  created_at    DateTime  @default(now())

  // Relations
  approved_vendors  vendors[]         @relation("ApprovedBy")
  escalated_tickets support_tickets[] @relation("EscalatedTo")
}

model support_agents {
  id               String    @id @default(uuid()) @db.Uuid
  email            String    @unique @db.VarChar(255)
  password_hash    String    @db.VarChar(255)
  name             String?   @db.VarChar(100)
  chatwoot_agent_id Int?
  is_active        Boolean   @default(true)
  last_login       DateTime?
  created_at       DateTime  @default(now())

  // Relations
  tickets support_tickets[]
  actions support_actions[]
}

// =====================================================
// CATEGORIES
// =====================================================

model categories {
  id            String   @id @default(uuid()) @db.Uuid
  name          String   @db.VarChar(100)
  name_ar       String?  @db.VarChar(100)
  name_fr       String?  @db.VarChar(100)
  name_es       String?  @db.VarChar(100)
  icon          String?  @db.VarChar(50)
  display_order Int      @default(0)
  is_active     Boolean  @default(true)
  created_at    DateTime @default(now())
  updated_at    DateTime @default(now()) @updatedAt

  // Relations
  vendors vendors[]
}

// =====================================================
// VENDORS
// =====================================================

model vendors {
  id                 String    @id @default(uuid()) @db.Uuid
  user_id            String?   @db.Uuid
  business_name      String    @db.VarChar(200)
  category_id        String?   @db.Uuid
  description        String?

  // Location
  location_city      String?   @db.VarChar(100)
  location_country   String?   @db.VarChar(100)
  latitude           Decimal?  @db.Decimal(10, 8)
  longitude          Decimal?  @db.Decimal(11, 8)

  // Business Info
  price_range        String?   @db.VarChar(10)

  // Ratings
  rating_avg         Decimal   @default(0) @db.Decimal(2, 1)
  review_count       Int       @default(0)

  // Approval & Commission
  status             String    @default("pending") @db.VarChar(20)
  commission_rate    Decimal   @default(10.00) @db.Decimal(4, 2)
  contract_notes     String?
  approved_at        DateTime?
  approved_by        String?   @db.Uuid

  // Verification
  is_verified        Boolean   @default(false)
  is_featured        Boolean   @default(false)
  documents          Json?

  // Stats
  response_time_hours Int?
  weddings_completed  Int      @default(0)

  created_at         DateTime  @default(now())
  updated_at         DateTime  @default(now()) @updatedAt

  // Relations
  user               users?     @relation(fields: [user_id], references: [id], onDelete: Cascade)
  category           categories? @relation(fields: [category_id], references: [id])
  approved_by_admin  admins?    @relation("ApprovedBy", fields: [approved_by], references: [id])
  packages           vendor_packages[]
  portfolio          vendor_portfolio[]
  bookings           bookings[]
  reviews            reviews[]
  conversations      chat_conversations[]
  commissions        commission_transactions[]
  budget_items       budget_items[]
  tasks              tasks[]
}

model vendor_packages {
  id            String   @id @default(uuid()) @db.Uuid
  vendor_id     String?  @db.Uuid
  name          String   @db.VarChar(100)
  description   String?
  price         Decimal  @db.Decimal(10, 2)
  features      Json?
  duration_hours Int?
  is_popular    Boolean  @default(false)
  is_active     Boolean  @default(true)
  created_at    DateTime @default(now())

  // Relations
  vendor   vendors?   @relation(fields: [vendor_id], references: [id], onDelete: Cascade)
  bookings bookings[]
}

model vendor_portfolio {
  id            String   @id @default(uuid()) @db.Uuid
  vendor_id     String?  @db.Uuid
  image_url     String   @db.VarChar(500)
  caption       String?  @db.VarChar(200)
  display_order Int      @default(0)
  created_at    DateTime @default(now())

  // Relations
  vendor vendors? @relation(fields: [vendor_id], references: [id], onDelete: Cascade)
}

// =====================================================
// WEDDINGS & COUPLES
// =====================================================

model weddings {
  id                   String    @id @default(uuid()) @db.Uuid
  user_id              String?   @db.Uuid
  partner1_name        String?   @db.VarChar(100)
  partner2_name        String?   @db.VarChar(100)
  wedding_date         DateTime? @db.Date

  // Budget
  budget_total         Decimal?  @db.Decimal(12, 2)
  budget_spent         Decimal   @default(0) @db.Decimal(12, 2)
  currency             String    @default("USD") @db.VarChar(3)

  // Guest Info
  guest_count_expected Int?

  // Preferences
  style_preferences    String[]
  cultural_traditions  String[]
  region               String?   @db.VarChar(50)

  // Progress
  planning_progress    Int       @default(0)

  created_at           DateTime  @default(now())
  updated_at           DateTime  @default(now()) @updatedAt

  // Relations
  user          users?      @relation(fields: [user_id], references: [id], onDelete: Cascade)
  bookings      bookings[]
  guests        guests[]
  budget_items  budget_items[]
  tasks         tasks[]
  invitations   invitations[]
  conversations chat_conversations[]
  reviews       reviews[]
}

// =====================================================
// BOOKINGS
// =====================================================

model bookings {
  id              String    @id @default(uuid()) @db.Uuid
  wedding_id      String?   @db.Uuid
  vendor_id       String?   @db.Uuid
  package_id      String?   @db.Uuid

  // Status
  status          String    @default("pending") @db.VarChar(20)

  // Dates
  booking_date    DateTime  @db.Date

  // Amounts
  total_amount    Decimal?  @db.Decimal(10, 2)
  deposit_amount  Decimal?  @db.Decimal(10, 2)
  deposit_paid    Boolean   @default(false)

  // Commission
  commission_rate   Decimal?  @db.Decimal(4, 2)
  commission_amount Decimal?  @db.Decimal(10, 2)
  vendor_payout     Decimal?  @db.Decimal(10, 2)

  // Notes
  couple_notes    String?
  vendor_notes    String?

  created_at      DateTime  @default(now())
  updated_at      DateTime  @default(now()) @updatedAt

  // Relations
  wedding       weddings?        @relation(fields: [wedding_id], references: [id], onDelete: Cascade)
  vendor        vendors?         @relation(fields: [vendor_id], references: [id], onDelete: Cascade)
  package       vendor_packages? @relation(fields: [package_id], references: [id])
  budget_items  budget_items[]
  tasks         tasks[]
  reviews       reviews[]
  commissions   commission_transactions[]
}

// =====================================================
// GUESTS & RSVP
// =====================================================

model guests {
  id                  String    @id @default(uuid()) @db.Uuid
  wedding_id          String?   @db.Uuid
  name                String    @db.VarChar(200)
  email               String?   @db.VarChar(255)
  phone               String?   @db.VarChar(20)
  group_name          String?   @db.VarChar(50)

  // RSVP
  rsvp_status         String    @default("pending") @db.VarChar(20)
  plus_one_allowed    Boolean   @default(false)
  plus_one_name       String?   @db.VarChar(200)
  plus_one_attending  Boolean?

  // Preferences
  meal_preference     String?   @db.VarChar(50)
  dietary_restrictions String?
  song_request        String?   @db.VarChar(200)
  message_to_couple   String?

  // Seating
  table_assignment    String?   @db.VarChar(50)

  // Tracking
  invitation_sent_at  DateTime?
  responded_at        DateTime?

  created_at          DateTime  @default(now())

  // Relations
  wedding weddings? @relation(fields: [wedding_id], references: [id], onDelete: Cascade)
}

// =====================================================
// BUDGET
// =====================================================

model budget_items {
  id               String    @id @default(uuid()) @db.Uuid
  wedding_id       String?   @db.Uuid
  category         String    @db.VarChar(50)
  description      String?   @db.VarChar(200)
  estimated_amount Decimal?  @db.Decimal(10, 2)
  actual_amount    Decimal?  @db.Decimal(10, 2)
  vendor_id        String?   @db.Uuid
  booking_id       String?   @db.Uuid
  is_paid          Boolean   @default(false)
  paid_date        DateTime? @db.Date
  notes            String?
  created_at       DateTime  @default(now())

  // Relations
  wedding  weddings? @relation(fields: [wedding_id], references: [id], onDelete: Cascade)
  vendor   vendors?  @relation(fields: [vendor_id], references: [id])
  booking  bookings? @relation(fields: [booking_id], references: [id])
}

// =====================================================
// TASKS
// =====================================================

model tasks {
  id               String    @id @default(uuid()) @db.Uuid
  wedding_id       String?   @db.Uuid
  title            String    @db.VarChar(200)
  description      String?
  due_date         DateTime? @db.Date
  is_completed     Boolean   @default(false)
  completed_at     DateTime?
  priority         String    @default("medium") @db.VarChar(10)
  category         String?   @db.VarChar(50)
  linked_vendor_id String?   @db.Uuid
  linked_booking_id String?  @db.Uuid
  months_before    Int?
  is_custom        Boolean   @default(false)
  created_at       DateTime  @default(now())

  // Relations
  wedding  weddings? @relation(fields: [wedding_id], references: [id], onDelete: Cascade)
  vendor   vendors?  @relation(fields: [linked_vendor_id], references: [id])
  booking  bookings? @relation(fields: [linked_booking_id], references: [id])
}

// =====================================================
// INVITATIONS
// =====================================================

model invitations {
  id            String    @id @default(uuid()) @db.Uuid
  wedding_id    String?   @db.Uuid
  template_id   String?   @db.VarChar(50)
  design_config Json?
  rsvp_deadline DateTime? @db.Date
  sent_count    Int       @default(0)
  opened_count  Int       @default(0)
  created_at    DateTime  @default(now())
  updated_at    DateTime  @default(now()) @updatedAt

  // Relations
  wedding weddings? @relation(fields: [wedding_id], references: [id], onDelete: Cascade)
}

// =====================================================
// CHAT
// =====================================================

model chat_conversations {
  id                   String    @id @default(uuid()) @db.Uuid
  wedding_id           String?   @db.Uuid
  vendor_id            String?   @db.Uuid
  firebase_chat_id     String    @unique @db.VarChar(100)
  last_message_at      DateTime?
  last_message_preview String?   @db.VarChar(200)
  unread_count_couple  Int       @default(0)
  unread_count_vendor  Int       @default(0)
  created_at           DateTime  @default(now())

  // Relations
  wedding weddings? @relation(fields: [wedding_id], references: [id], onDelete: Cascade)
  vendor  vendors?  @relation(fields: [vendor_id], references: [id], onDelete: Cascade)
}

// =====================================================
// REVIEWS
// =====================================================

model reviews {
  id              String    @id @default(uuid()) @db.Uuid
  vendor_id       String?   @db.Uuid
  wedding_id      String?   @db.Uuid
  booking_id      String?   @db.Uuid
  rating          Int
  review_text     String?
  vendor_response String?
  is_verified     Boolean   @default(false)
  created_at      DateTime  @default(now())

  // Relations
  vendor  vendors?  @relation(fields: [vendor_id], references: [id], onDelete: Cascade)
  wedding weddings? @relation(fields: [wedding_id], references: [id], onDelete: Cascade)
  booking bookings? @relation(fields: [booking_id], references: [id])
}

// =====================================================
// SUPPORT
// =====================================================

model support_tickets {
  id                     String    @id @default(uuid()) @db.Uuid
  user_id                String?   @db.Uuid
  agent_id               String?   @db.Uuid
  chatwoot_conversation_id Int?
  subject                String?   @db.VarChar(200)
  status                 String    @default("open") @db.VarChar(20)
  priority               String    @default("normal") @db.VarChar(10)
  escalated_to           String?   @db.Uuid
  escalated_at           DateTime?
  resolved_at            DateTime?
  created_at             DateTime  @default(now())

  // Relations
  agent          support_agents?   @relation(fields: [agent_id], references: [id])
  escalated_admin admins?          @relation("EscalatedTo", fields: [escalated_to], references: [id])
  actions        support_actions[]
}

model support_actions {
  id             String   @id @default(uuid()) @db.Uuid
  ticket_id      String?  @db.Uuid
  agent_id       String?  @db.Uuid
  action_type    String?  @db.VarChar(50)
  action_details Json?
  created_at     DateTime @default(now())

  // Relations
  ticket support_tickets? @relation(fields: [ticket_id], references: [id])
  agent  support_agents?  @relation(fields: [agent_id], references: [id])
}

// =====================================================
// COMMISSION TRACKING
// =====================================================

model commission_transactions {
  id                String    @id @default(uuid()) @db.Uuid
  booking_id        String?   @db.Uuid
  vendor_id         String?   @db.Uuid
  gross_amount      Decimal   @db.Decimal(10, 2)
  commission_rate   Decimal   @db.Decimal(4, 2)
  commission_amount Decimal   @db.Decimal(10, 2)
  vendor_payout     Decimal   @db.Decimal(10, 2)
  status            String    @default("pending") @db.VarChar(20)
  payout_date       DateTime?
  created_at        DateTime  @default(now())

  // Relations
  booking bookings? @relation(fields: [booking_id], references: [id])
  vendor  vendors?  @relation(fields: [vendor_id], references: [id])
}
