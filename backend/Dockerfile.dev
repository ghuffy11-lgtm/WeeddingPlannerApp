FROM node:20-alpine

WORKDIR /app

# Install dependencies for native modules and OpenSSL
RUN apk add --no-cache python3 make g++ openssl openssl-dev

# Copy package files
COPY package*.json ./
COPY prisma ./prisma/

# Install all dependencies (including dev)
RUN npm install

# Expose port
EXPOSE 3000

# Create startup script that regenerates Prisma client and starts dev server
RUN echo '#!/bin/sh' > /start.sh && \
    echo 'npx prisma generate' >> /start.sh && \
    echo 'npm run dev' >> /start.sh && \
    chmod +x /start.sh

CMD ["/start.sh"]
